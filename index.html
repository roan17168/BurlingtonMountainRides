<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BurlingtonMountainRides â€“ Driver Calendar</title>
  <style>
    :root {
      --bg: #0f172a;        /* slate-900 */
      --panel: #111827;     /* gray-900 */
      --panel-2: #1f2937;   /* gray-800 */
      --text: #e5e7eb;      /* gray-200 */
      --muted: #9ca3af;     /* gray-400 */
      --brand: #22d3ee;     /* cyan-400 */
      --brand-2: #06b6d4;   /* cyan-500 */
      --ok: #22c55e;        /* green-500 */
      --warn: #f59e0b;      /* amber-500 */
      --danger: #ef4444;    /* red-500 */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #020617 60%, #020617 100%);
      color: var(--text);
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(8px);
      background: rgba(15, 23, 42, .9);
      border-bottom: 1px solid #1f2937;
    }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 16px 20px; }
    .title { display:flex; align-items:center; gap:12px; }
    .title h1 { margin: 0; font-size: 22px; letter-spacing: .3px; }
    .btn {
      background: var(--brand-2);
      color: #001018;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      transition: .2s transform, .2s opacity, .2s box-shadow;
    }
    .btn:hover {
      transform: translateY(-1px);
      opacity: .95;
      box-shadow: 0 10px 20px rgba(15,23,42,.7);
    }
    .btn:disabled { opacity: .5; cursor: not-allowed; }

    .toolbar { display:flex; gap: 10px; align-items:center; justify-content: space-between; }

    /* Calendar list */
    .calendar {
      max-width: 1000px;
      margin: 16px auto;
      padding: 0 20px 40px;
      height: calc(100vh - 82px);
      overflow-y: auto;
      scroll-behavior: smooth;
    }
    .day {
      background: var(--panel);
      border: 1px solid #1f2937;
      border-radius: 18px;
      padding: 18px;
      margin: 12px 0;
      box-shadow: 0 12px 25px rgba(0,0,0,.5);
    }
    .day h2 {
      margin: 0 0 12px;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .2px;
      color: #cbd5e1;
    }

    .slots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
    }

    .slot {
      background: var(--panel-2);
      border: 1px solid #293548;
      border-radius: 14px;
      padding: 12px;
      position: relative;
      cursor: pointer;
      transition: .2s transform, .2s box-shadow, .2s opacity;
    }
    .slot:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(0,0,0,.55);
    }
    .slot.gray {
      filter: grayscale(1);
      opacity: .65;
      cursor: default;
    }

    .slot .hdr {
      display:flex;
      align-items:center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .slot .mountain {
      font-weight: 800;
      font-size: 16px;
    }

    /* price bottom-right */
    .slot .price {
      position:absolute;
      right:10px;
      bottom:8px;
      font-weight:900;
      color:#22d3ee;
    }

    .slot .meta {
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap:wrap;
      padding-right: 60px;
    }
    .chip {
      background:#0b2530;
      color:#7dd3fc;
      padding: 2px 8px;
      border-radius: 999px;
      border:1px solid #113444;
      font-size: 11px;
      font-weight:700;
    }

    .kebab {
      position:absolute;
      top:6px;
      right:6px;
      width:26px;
      height:26px;
      border-radius:8px;
      border:1px solid #293548;
      background:#020617;
      color:#e5e7eb;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .empty { color: var(--muted); font-style: italic; }

    /* Modal */
    dialog {
      border: none;
      width: min(820px, 92vw);
      border-radius: 18px;
      padding: 0;
      background: #020617;
      color: var(--text);
      box-shadow: 0 30px 60px rgba(0,0,0,.7);
    }
    .modal-hdr {
      display:flex;
      justify-content: space-between;
      align-items:center;
      padding: 16px 18px;
      border-bottom: 1px solid #1f2937;
      background:#020617;
    }
    .modal-body {
      padding: 18px;
      max-height: 70vh;
      overflow: auto;
      background:#020617;
    }
    .x {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 22px;
      cursor:pointer;
    }

    /* Form */
    form { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .full { grid-column: 1/-1; }
    label {
      display:block;
      font-size: 12px;
      color:#9ca3af;
      margin-bottom: 6px;
    }
    input[type="text"],
    input[type="date"],
    input[type="time"],
    input[type="tel"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      background: #020617;
      color: var(--text);
      border:1px solid #113444;
      border-radius:10px;
      outline: none;
    }
    textarea { min-height: 90px; resize: vertical; }
    .range-wrap { display:flex; gap:10px; align-items:center; }
    input[type="range"] { width:100%; }
    .pill {
      background:#0b2530;
      color:#67e8f9;
      border:1px solid #0e3a4a;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
    }

    .footer {
      display:flex;
      justify-content:flex-end;
      gap: 8px;
      padding: 12px 18px 18px;
      background:#020617;
    }

    .detail { display:grid; gap: 10px; }
    .detail .kv {
      background:#020617;
      border:1px solid #113444;
      border-radius: 10px;
      padding: 10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .detail .kv strong { color:#93c5fd; }

    .toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background:#05222d;
      color:#e5faff;
      padding: 10px 14px;
      border-radius: 10px;
      border:1px solid #0d3a48;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
      font-weight:700;
      display:none;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap toolbar">
      <div class="title">
        <!-- Mountain icon -->
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 19l6-10 4 7 2-3 6 6H3z" stroke="#22d3ee" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h1>BurlingtonMountainRides</h1>
      </div>
      <div>
        <button id="addBtn" class="btn" type="button">+ Add event</button>
      </div>
    </div>
  </header>

  <main class="calendar" id="calendar" aria-live="polite"></main>

  <!-- Add Ride Modal (form-only; no raw JSON input) -->
  <dialog id="addModal" aria-modal="true">
    <div class="modal-hdr">
      <strong>Create a ride</strong>
      <button class="x" onclick="closeAddModal()" aria-label="Close">âœ•</button>
    </div>
    <div class="modal-body">
      <form id="rideForm">
        <div>
          <label for="date">Date of trip</label>
          <input id="date" name="date" type="date" required />
        </div>
        <div>
          <label for="depart">Approximate Departure</label>
          <input id="depart" name="depart" type="time" required />
        </div>
        <div class="full">
          <label for="mountain">Mountain destination</label>
          <input id="mountain" name="mountain" type="text"
                 placeholder="e.g., Stowe Mountain Resort" required />
        </div>
        <div class="full">
          <label>Pitch In For Gas (amount)</label>
          <div class="range-wrap">
            <input id="amount" name="amount" type="range"
                   min="0" max="30" step="0.5" value="5"
                   oninput="amtOut.textContent='$'+Number(this.value).toFixed(2)" />
            <span class="pill" id="amtOut">$5.00</span>
          </div>
        </div>
        <div>
          <label for="method">Payment method</label>
          <select id="method" name="method">
            <option>Venmo</option>
            <option>Cash</option>
          </select>
        </div>
        <div>
          <label for="seats">Number of seats</label>
          <input id="seats" name="seats" type="number" min="1" max="8" value="3" required />
        </div>
        <div class="full">
          <label for="notes">Payment notes (optional)</label>
          <textarea id="notes" name="notes"
                    placeholder="Venmo @handle, includes parking, etc."></textarea>
        </div>
        <div class="full">
          <label for="phone">Phone number</label>
          <input id="phone" name="phone" type="tel" inputmode="tel"
                 placeholder="000-000-0000" required />
        </div>
      </form>
    </div>
    <div class="footer">
      <button class="btn" onclick="handleSaveRide()">Save ride</button>
    </div>
  </dialog>

  <!-- Detail / Join -->
  <dialog id="detailModal" aria-modal="true">
    <div class="modal-hdr">
      <strong id="detailTitle">Ride details</strong>
      <button class="x" onclick="closeDetail()" aria-label="Close">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="detail" id="detailBody"></div>
    </div>
    <div class="footer" id="detailFooter"></div>
  </dialog>

  <!-- Join Confirmation Modal -->
  <dialog id="joinModal" aria-modal="true">
    <div class="modal-hdr">
      <strong>You're in! ðŸŽ‰</strong>
      <button class="x" onclick="closeJoin()" aria-label="Close">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="joinBody"></div>
    </div>
    <div class="footer">
      <button class="btn" onclick="closeJoin()">Close</button>
    </div>
  </dialog>

  <!-- Manage (three-dot menu on card: delete/update seats) -->
  <dialog id="manageModal" aria-modal="true">
    <div class="modal-hdr">
      <strong>Manage ride</strong>
      <button class="x" onclick="closeManage()" aria-label="Close">âœ•</button>
    </div>
    <div class="modal-body">
      <form id="manageForm">
        <div class="full">
          <label for="mPhone">Creator's Phone Number</label>
          <input id="mPhone" type="tel" inputmode="tel" placeholder="000-000-0000" required>
        </div>
        <div>
          <label for="mSeatsLeft">New seats left</label>
          <input id="mSeatsLeft" type="number" min="0" max="99" placeholder="e.g., 2">
        </div>
      </form>
    </div>
    <div class="footer">
      <button class="btn" id="btnUpdateSeats">Update seats</button>
      <button class="btn" id="btnDelete" style="background:var(--danger)">Delete ride</button>
    </div>
  </dialog>

  <div class="toast" id="toast"></div>

  <script>
    // ===== Utilities & State =====
    const $$ = (sel, root=document) => root.querySelector(sel);
    let trips = [];          // list of rides from the server
    let manageTargetId = null;

    function toast(msg, ms=1800) {
      const t = $$('#toast');
      t.textContent = msg;
      t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', ms);
    }
    function fmtMoney(n){ return '$' + Number(n).toFixed(2); }
    function todayISO(){
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    }
    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    // ===== Calendar generation =====
    const CAL_DAYS = 60;

    function renderCalendar(){
      const cal = $$('#calendar');
      cal.innerHTML = '';

      const start = new Date();
      start.setHours(0,0,0,0);

      for(let i=0;i<CAL_DAYS;i++){
        const d = new Date(start); d.setDate(d.getDate()+i);
        const ds = d.toLocaleDateString(undefined,{
          weekday:'long', month:'long', day:'numeric', year:'numeric'
        });
        const iso = d.toISOString().slice(0,10);

        const day = document.createElement('section');
        day.className='day';
        day.dataset.date = iso;
        day.innerHTML = `<h2>${ds}</h2><div class="slots" role="list"></div>`;
        const list = day.querySelector('.slots');

        const dayTrips = trips
          .filter(t => t.date === iso)
          .sort((a,b) => a.depart.localeCompare(b.depart));

        if(dayTrips.length===0){
          const p = document.createElement('p');
          p.className='empty';
          p.textContent='No rides yet. Be the first to add one!';
          list.appendChild(p);
        } else {
          dayTrips.forEach(t => list.appendChild(renderSlot(t)));
        }
        cal.appendChild(day);
      }
    }

    function renderSlot(t){
      const slot = document.createElement('article');
      slot.className = 'slot' + (t.seatsLeft<=0 ? ' gray' : '');
      slot.setAttribute('role','listitem');
      slot.innerHTML = `
        <div class="hdr">
          <div class="mountain">${escapeHtml(t.mountain)}</div>
        </div>
        <div class="meta">
          <span class="chip">Dep ${t.depart}</span>
          <span class="chip" aria-label="Seats left">Seats: ${t.seatsLeft}</span>
        </div>
        <div class="price">${fmtMoney(t.amount)}</div>
        <button class="kebab" title="Manage">â‹¯</button>
      `;

      const kebab = slot.querySelector('.kebab');
      // kebab always works (even when full)
      kebab.addEventListener('click', (e) => {
        e.stopPropagation();
        openManage(t.id);
      });

      // clicking card only opens detail if seats left
      if(t.seatsLeft > 0){
        slot.addEventListener('click', () => openDetail(t.id));
      }

      return slot;
    }

    // ===== Add Ride =====
    document.addEventListener('DOMContentLoaded', () => {
      $$('#addBtn').addEventListener('click', () => openAddModal());
      loadTrips();
    });

    function openAddModal(){
      $$('#date').value = todayISO();
      $$('#amtOut').textContent = fmtMoney($$('#amount').value);
      $$('#addModal').showModal();
    }
    function closeAddModal(){ $$('#addModal').close(); }

    async function handleSaveRide(){
      const fd = new FormData($$('#rideForm'));
      const date = fd.get('date');
      const depart = fd.get('depart');
      const mountain = (fd.get('mountain')||'').trim();
      const amount = Number(fd.get('amount'));
      const method = fd.get('method');
      const notes = (fd.get('notes')||'').trim();
      const seats = Math.max(0, Number(fd.get('seats'))|0);
      const phone = (fd.get('phone')||'').trim();

      if(!date || !depart || !mountain || !seats || !phone){
        toast('Please complete all required fields.');
        return;
      }
      // enforce payment methods
      if(method !== 'Venmo' && method !== 'Cash'){
        toast('Payment method must be Venmo or Cash.');
        return;
      }

      // JSON shape (server normalizes)
      const payload = {
        title: 'Driver Application Form',
        trips: [{
          date_of_trip: date,
          aprox_dep: depart,
          mountain_destination: mountain,
          'Pitch In For Gas': { amount, method, notes },
          number_of_seats: seats,
          phone_number: phone
        }]
      };

      try{
        const res = await fetch('add.php',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload.trips[0])
        });
        const data = await res.json();
        if(data.success){
          trips = data.rides;
          renderCalendar();
          closeAddModal();
          toast('Ride saved!');
        } else {
          toast(data.error || 'Unable to save.');
        }
      } catch(e){
        console.error(e);
        toast('Network error.');
      }
    }

    // ===== Details / Join =====
    function openDetail(id){
      const t = trips.find(r => r.id === id);
      if(!t) return;

      $$('#detailTitle').textContent = t.mountain + ' â€“ ' + t.date;

      const body = $$('#detailBody');
      body.innerHTML = '';
      body.appendChild(kv('Departure', t.depart));
      body.appendChild(kv('Pitch In For Gas', fmtMoney(t.amount)));
      body.appendChild(kv('Payment method', t.method));
      if(t.notes) body.appendChild(kv('Notes', t.notes));
      body.appendChild(kv('Seats left', `${t.seatsLeft} / ${t.seats}`));

      const ft = $$('#detailFooter');
      ft.innerHTML = '';
      const joinBtn = document.createElement('button');
      joinBtn.className='btn';
      joinBtn.textContent='Join ride';
      joinBtn.disabled = t.seatsLeft <= 0;
      joinBtn.addEventListener('click', () => joinRide(t.id));
      ft.appendChild(joinBtn);

      $$('#detailModal').showModal();
    }
    function closeDetail(){ $$('#detailModal').close(); }

    function kv(label, val){
      const el = document.createElement('div');
      el.className='kv';
      el.innerHTML = `<strong>${escapeHtml(label)}</strong><span>${escapeHtml(String(val))}</span>`;
      return el;
    }

    async function joinRide(id){
      try{
        const res = await fetch('join.php',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id })
        });
        const data = await res.json();
        if(data.success){
          trips = data.rides;
          renderCalendar();
          closeDetail();

          const r = data.ride;
          const jb = $$('#joinBody');
          jb.innerHTML = '';

          const p1 = document.createElement('p');
          p1.innerHTML = `Driver phone: <strong>${escapeHtml(r.phone)}</strong>`;
          jb.appendChild(p1);

          const p2 = document.createElement('p');
          p2.textContent =
            `Message you can send: "Hi! I just joined your ride to ${r.mountain}, on ${r.date}!"`;
          jb.appendChild(p2);

          $$('#joinModal').showModal();
        } else {
          toast(data.error || 'Unable to join.');
        }
      } catch(e){
        console.error(e);
        toast('Network error joining.');
      }
    }
    function closeJoin(){ $$('#joinModal').close(); }

    // ===== Manage (delete / update seats) via kebab =====
    function openManage(id){
      manageTargetId = id;
      $$('#manageModal').showModal();
    }
    function closeManage(){
      manageTargetId = null;
      $$('#manageModal').close();
      $$('#manageForm').reset();
    }

    $$('#btnDelete').addEventListener('click', async () => {
      const phone = ($$('#mPhone').value||'').trim();
      if(!phone){ toast('Enter your phone number'); return; }

      try{
        const res = await fetch('delete.php',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id: manageTargetId, phone_number: phone })
        });
        const data = await res.json();
        if(data.success){
          trips = data.rides;
          renderCalendar();
          closeManage();
          toast('Ride removed.');
        } else {
          toast(data.error || 'Unable to remove.');
        }
      } catch(e){
        console.error(e);
        toast('Network error');
      }
    });

    $$('#btnUpdateSeats').addEventListener('click', async () => {
      const phone = ($$('#mPhone').value||'').trim();
      const newSeatsLeftRaw = $$('#mSeatsLeft').value;

      if(!phone){ toast('Enter your phone number'); return; }
      if(newSeatsLeftRaw === '' || newSeatsLeftRaw === null){
        toast('Enter new seats left');
        return;
      }

      const newSeatsLeft = Math.max(0, Number(newSeatsLeftRaw)|0);

      try{
        const res = await fetch('update.php',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            id: manageTargetId,
            phone_number: phone,
            new_seats_left: newSeatsLeft
          })
        });
        const data = await res.json();
        if(data.success){
          trips = data.rides;
          renderCalendar();
          closeManage();
          toast('Seats updated.');
        } else {
          toast(data.error || 'Unable to update');
        }
      } catch(e){
        console.error(e);
        toast('Network error');
      }
    });

    // ===== Backend IO =====
    async function loadTrips(){
      try{
        const res = await fetch('load.php?_=' + Date.now());
        if(!res.ok) throw new Error('Failed');
        trips = await res.json();
      } catch(e){
        console.error(e);
        trips = [];
      }
      renderCalendar();
    }
  </script>
</body>
</html>
